use SeniorCare;
Go

RaisError ('Creating procedures.',0 ,1) With NoWait;
Go

Create or Alter Proc uspAddPType
@TypeName NVarchar(64)
as
Begin
	If exists (Select 1 From Person.Type Where TypeName=@TypeName)
	Begin
		Print 'Duplicate found!!!';
	End;
	Else
	Begin
		Insert Into Person.Type(TypeName,DateModified) Values
			(@TypeName,GetDate());
	End;
End;
GO

Create or Alter Proc uspValidCNP
@PNNTest Nvarchar(13),
@Result Tinyint = 0
as
Begin
	Declare @ConvDate Date = TRY_CONVERT(Date, SUBSTRING(@PNNTest,2,6),12);
	Declare @I Int = 1;
	Declare @PRes Int = 0;
	Declare @Pon NVarchar(12) = '279146358279'

	If LEN(@PNNTest)<>13	   
		Begin	
			RaisError ('PNN lenght does not meet the required length!',0 ,1) With NoWait; --Lungime eronata.
  			Set @Result = 1;
			Return;
		End;
		
	If ISNUMERIC(@PNNTest)<>1 and @PNNTest like '%[^0-9]%' 
		Begin
			RaisError ('PNN must contain only numbers!',0 ,1) With NoWait;  --Nu este format doar din cifre.
   			Set @Result = 2;
			Return;
		End;
		
	IF Left(@PNNTest,1) not like '[1-9]'
		Begin 
			RaisError ('First number can not be 0!',0 ,1) With NoWait; --Se verifica, daca prima cifra este intr 1 si 9
   			Set @Result = 3; 
			Return;
		End;
	IF @ConvDate is NULL Or @ConvDate < '1753-01-01' Or @ConvDate > '9999-12-31'
		Begin
			RaisError ('Invalid date!',0 ,1) With NoWait; --Se verifica daca data nasterii este valida
  			Set @Result = 4; 
			Return;
		End;
		
	IF CAST(SUBSTRING(@PNNTest,8,2) as TinyInt) not between 1 and 52
		Begin
			RaisError ('Invalid region code!',0 ,1) With NoWait; --Se verifica validitatea codului de judet
   			Set @Result = 5;
			Return;
		End;
		
	While @I < LEN(@PNNTest)
		Begin
			Set @PRes = @PRes + (CAST(SUBSTRING(@PNNTest,@I,1) as Int) * CAST(SUBSTRING(@Pon,@I,1) as Int));
			Set @I += 1;
		End;
		
	While @PRes>=11
		Begin
			Set @PRes -= 11;
		End;
		
	If CAST(SUBSTRING(@PNNTest, 13,1) As TinyInt)<>@PRes 
		Begin			
			RaisError ('Invalid control number!',0 ,1) With NoWait; --Se verifica cifra de control
   			Set @Result = 6;
			Return;
		End;
End;
Go

Create or Alter Proc uspAddContact
@CName as NVarchar(256)
as
Begin
	If Exists ( Select 1 From Person.ContactName Where ContactName=@CName)
	Begin
		Print 'Duplicate found!!!';
	End
	Else
	Begin
		Insert Into Person.Contact 
			(
			ContactName, DateModified
			) Values 
			(
			@CName,Getdate()
			);
	End
End;

Create or Alter Proc uspAddPerson
@PType Tinyint,
@FName NVarchar(50),
@MName NVarchar(50) = '',
@LName Nvarchar(50),
@PNN NVarchar(13),
@ALine1 NVarchar(512) = NULL,
@ALine2 NVarchar(512) = NULL,
@City NVarchar(128) = NULL,
@Prov NVarchar(64) = NULL,
@Country NVarchar(64) = 'Romania',
@PCode NVarchar(32) = NULL,
@PhoneNo NVarchar(15) = NULL,
@Email NVarchar(256) = NULL
as
Begin
	Declare @Res as Tinyint = 0;
	Declare @FullName as NVarchar(150) = '',
	Declare @CID as Int = 0;
	Exec uspValidCNP @PNNTest = @PNN, @Result = @Res Output;
	If @Res = 0 Then
		Begin
			If Len(Trim(@MName))<>0 or @MName is not NULL
				Begin
					Set @FullName = Trim(@FName) + ' ' + Trim(@MName) + ' ' + Trim(@LName);
				End;
			Else
				Begin
					Set @FullName = Trim(@FName) + ' ' + Trim(@LName);
				End;
			Insert Into Person.Person 
				(
				PersonType,	FirstName, MiddleName, LastName, PNN, DateModified
				) Values
				(
				@PType, @FName, @MNam, @LName, @PNN, Getdate()
				);
			If not exists ( Select 1 From Person.Contact Where ContactName = @FullName) Then
				Begin
					Insert Into Person.Contact
						(
						ContactName, DateModified
						) Values
						(
						@FullName, GetDate()
						);
				End;
			If 
				((@ALine1 is not NULL or @ALine2 is not NULL) and
				@City is not NULL and @Prov is not NULL and @PCode is not NULL)
				Begin
					Select 
					@CID = PersonID 
					From Person.Person
					Where PNN=@PNN;
					Insert Into Person.Address
						(
						PersonID, AddressLine1, AddressLine2, City, 
						Province, Country, PostalCode, Country
						 ) Values
						 ( 
						 @CID, @ALine1, @ALine2, @City,
						 @Prov, @Country, Getdate()
						 );
				End;
			Else
				Begin
					Print 'Date adresa invalide!!!';
					Break;
				End;

				-- Continue from here

		End;
End;


RaisError ('Done.',0 ,1) With NoWait;
Go

Use master;
Go
